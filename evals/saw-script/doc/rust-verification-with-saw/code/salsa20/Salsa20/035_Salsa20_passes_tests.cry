quarterround : [4][32] -> [4][32]
quarterround [y0, y1, y2, y3] =
  [z0, z1, z2, z3]
  where
    z1 = y1 ^ ((y0 + y3) <<< 0x7)
    z2 = y2 ^ ((z1 + y0) <<< 0x9)
    z3 = y3 ^ ((z2 + z1) <<< 0xd)
    z0 = y0 ^ ((z3 + z2) <<< 0x12)
rowround : [16][32] -> [16][32]
rowround
  [y0, y1, y2, y3, y4, y5, y6, y7, y8, y9, y10, y11, y12, y13, y14,
   y15] =
  [z0,
  z1,
  z2,
  z3,
  z4,
  z5,
  z6,
  z7,
  z8,
  z9,
  z10,
  z11,
  z12,
  z13,
  z14,
  z15]
  where
    [z0, z1, z2, z3] = quarterround [y0, y1, y2, y3]
    [z5, z6, z7, z4] = quarterround [y5, y6, y7, y4]
    [z10, z11, z8, z9] = quarterround [y10, y11, y8, y9]
    [z15, z12, z13, z14] = quarterround [y15, y12, y13, y14]
columnround : [16][32] -> [16][32]
columnround
  [x0, x1, x2, x3, x4, x5, x6, x7, x8, x9, x10, x11, x12, x13, x14,
   x15] =
  [y0,
  y1,
  y2,
  y3,
  y4,
  y5,
  y6,
  y7,
  y8,
  y9,
  y10,
  y11,
  y12,
  y13,
  y14,
  y15]
  where
    [y0, y4, y8, y12] = quarterround [x0, x4, x8, x12]
    [y5, y9, y13, y1] = quarterround [x5, x9, x13, x1]
    [y10, y14, y2, y6] = quarterround [x10, x14, x2, x6]
    [y15, y3, y7, y11] = quarterround [x15, x3, x7, x11]
doubleround : [16][32] -> [16][32]
doubleround xs = rowround (columnround (xs))
littleendian : [4][8] -> [32]
littleendian b = join (reverse b)
littleendian_inverse : {n} (fin n) => [8 * n] -> [n][8]
littleendian_inverse b = reverse (split b)
littleendian_state : [64][8] -> [16][32]
littleendian_state b = [littleendian xi | xi <- split b]
littleendian_state_inverse : [16][32] -> [64][8]
littleendian_state_inverse w = join (map littleendian_inverse w)
Salsa20 : [32] -> [64][8] -> [64][8]
Salsa20 count xs =
  littleendian_state_inverse (Salsa20_rounds count xw xw)
  where
    xw = littleendian_state xs
Salsa20_rounds : [32] -> [16][32] -> [16][32] -> [16][32]
Salsa20_rounds count xw xw' =
  xw + zs @ (count / 2)
  where
    zs = [xw'] # [doubleround zi | zi <- zs]
/* pragma Salsa20_passes_tests : property */
Salsa20_passes_tests =
  (Salsa20 20
    [0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0] == [0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0]) /\ (Salsa20 20
    [211,
    159,
    13,
    115,
    76,
    55,
    82,
    183,
    3,
    117,
    222,
    37,
    191,
    187,
    234,
    136,
    49,
    237,
    179,
    48,
    1,
    106,
    178,
    219,
    175,
    199,
    166,
    48,
    86,
    16,
    179,
    207,
    31,
    240,
    32,
    63,
    15,
    83,
    93,
    161,
    116,
    147,
    48,
    113,
    238,
    55,
    204,
    36,
    79,
    201,
    235,
    79,
    3,
    81,
    156,
    47,
    203,
    26,
    244,
    243,
    88,
    118,
    104,
    54] == [109,
  42,
  178,
  168,
  156,
  240,
  248,
  238,
  168,
  196,
  190,
  203,
  26,
  110,
  170,
  154,
  29,
  29,
  150,
  26,
  150,
  30,
  235,
  249,
  190,
  163,
  251,
  48,
  69,
  144,
  51,
  57,
  118,
  40,
  152,
  157,
  180,
  57,
  27,
  94,
  107,
  42,
  236,
  35,
  27,
  111,
  114,
  114,
  219,
  236,
  232,
  135,
  111,
  155,
  110,
  18,
  24,
  232,
  95,
  158,
  179,
  19,
  48,
  202]) /\ (Salsa20 20
    [88,
    118,
    104,
    54,
    79,
    201,
    235,
    79,
    3,
    81,
    156,
    47,
    203,
    26,
    244,
    243,
    191,
    187,
    234,
    136,
    211,
    159,
    13,
    115,
    76,
    55,
    82,
    183,
    3,
    117,
    222,
    37,
    86,
    16,
    179,
    207,
    49,
    237,
    179,
    48,
    1,
    106,
    178,
    219,
    175,
    199,
    166,
    48,
    238,
    55,
    204,
    36,
    31,
    240,
    32,
    63,
    15,
    83,
    93,
    161,
    116,
    147,
    48,
    113] == [179,
  19,
  48,
  202,
  219,
  236,
  232,
  135,
  111,
  155,
  110,
  18,
  24,
  232,
  95,
  158,
  26,
  110,
  170,
  154,
  109,
  42,
  178,
  168,
  156,
  240,
  248,
  238,
  168,
  196,
  190,
  203,
  69,
  144,
  51,
  57,
  29,
  29,
  150,
  26,
  150,
  30,
  235,
  249,
  190,
  163,
  251,
  48,
  27,
  111,
  114,
  114,
  118,
  40,
  152,
  157,
  180,
  57,
  27,
  94,
  107,
  42,
  236,
  35])