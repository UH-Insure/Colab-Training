module Primitive::Symmetric::Cipher::Block::Modes::CFB where
import interface Primitive::Symmetric::Cipher::Block::CipherInterface as C

encrypt : {s, n} (fin s, fin n, s >= 0, s <= C::BlockSize)
    => [C::KeySize] -> [C::BlockSize] -> [n][s] -> [n][s]
encrypt K IV Ps = Cs
    where
        CIPH_K = C::encrypt K
        Is = [ (drop`{s} I_j_1) # C_j_1
             | I_j_1 <- [IV] # Is
             | C_j_1 <- Cs
             ]
        Cs = [ P_j ^ (take`{s} (CIPH_K I_j))
             | P_j <- Ps
             | I_j <- [IV] # Is
             ]

decrypt : {s, n} (fin s, fin n, s >= 0, s <= C::BlockSize)
    => [C::KeySize] -> [C::BlockSize] -> [n][s] -> [n][s]
decrypt K IV Cs = Ps
    where
        CIPH_K = C::encrypt K
        Is = [ (drop`{s} I_j_1) # C_j_1
             | I_j_1 <- [IV] # Is
             | C_j_1 <- Cs
             ]
        Ps = [ C_j ^ (take`{s} (CIPH_K I_j))
             | C_j <- Cs
             | I_j <- [IV] # Is
             ]

encryptCorrect : {s, n} (fin n, s >= 0, s <= C::BlockSize)
    => [C::KeySize] -> [C::BlockSize] -> [n][s] -> Bool
property encryptCorrect K IV Ps = (decrypt K IV (encrypt K IV Ps)) == Ps